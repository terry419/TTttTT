// --- 파일 위치: Assets/1.Scripts/Gameplay/CardEffectHandlers/SplitShotHandler.cs ---

using UnityEngine;
using System;

/// <summary>
/// 'SplitShot' 타입의 카드 효과를 처리하는 클래스입니다.
/// </summary>
public class SplitShotHandler : ICardEffectHandler
{
    public void Execute(CardDataSO cardData, EffectExecutor executor, Transform spawnPoint)
    {
        GameObject bulletPrefab = cardData.bulletPrefab;
        if (bulletPrefab == null)
        {
            Debug.LogError($"[SplitShotHandler] 오류: 분열 카드 '{cardData.cardName}'에 bulletPrefab이 할당되지 않았습니다!");
            return;
        }

        // 기본 발사 각도를 계산합니다.
        float baseAngle = executor.GetTargetingAngle(cardData.targetingType);

        // 발사할 총알의 개수, 각도, 데미지 등을 계산합니다.
        int projectileCount = Mathf.Max(1, (int)cardData.triggerValue);
        float angleStep = 360f / projectileCount;
        float totalDamage = executor.CalculateTotalDamage(cardData);
        string shotID = Guid.NewGuid().ToString(); // 모든 분열탄이 동일한 피격 판정을 공유하도록 ID를 생성합니다.

        for (int i = 0; i < projectileCount; i++)
        {
            // 기본 각도에서 발사 각도를 계산합니다.
            float currentAngle = baseAngle + (angleStep * i);
            Quaternion rotation = Quaternion.Euler(0, 0, currentAngle);
            Vector2 direction = rotation * Vector2.right;

            GameObject bulletGO = executor.poolManager.Get(cardData.bulletPrefab);
            if (bulletGO == null) continue;

            bulletGO.transform.position = executor.playerController.firePoint.position;
            bulletGO.transform.rotation = rotation;

            if (bulletGO.TryGetComponent<BulletController>(out var bullet))
            {
                bullet.Initialize(direction, cardData.bulletSpeed, totalDamage, shotID, cardData);
            }
        }
    }
}
